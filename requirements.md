# 串口MCP服务需求规格文档

## 项目概述

构建一个基于MCP (Model Context Protocol) 的本地串口服务，允许LLM通过标准化接口与串口设备进行交互，主要用于嵌入式系统开发和调试。同时提供可视化调试界面，方便开发者直接操作和调试。

## 详细功能需求

### 1. 串口基础功能模块

#### 1.1 串口连接管理
- **串口打开/关闭功能**
  - 支持指定端口名称（如COM1, COM15, /dev/ttyUSB0等）
  - 支持配置波特率（常见：9600, 115200, 2000000等）
  - 支持配置数据位、停止位、校验位
  - 支持超时设置
  - 连接状态检测和错误处理

#### 1.2 串口数据接收
- **实时数据接收**
  - 后台线程持续监听串口数据
  - 按行缓存接收到的数据
  - 带时间戳记录每行数据
  - 支持不同编码格式（UTF-8, GBK等）
  - 支持HEX显示模式和字符串显示模式
  - 异常处理（断线重连等）
  - 数据过滤和搜索功能

#### 1.3 串口数据发送
- **命令发送功能**
  - 支持字符串命令发送
  - 支持十六进制数据发送
  - 支持添加行结束符（\r\n, \n等）
  - 支持预设命令快速发送
  - 发送确认和错误处理
  - 支持自动发送功能

### 2. 图形用户界面 (GUI)

#### 2.1 整体布局
基于提供的界面截图设计，采用三栏布局：

**左侧配置面板：**
- 端口配置区
  - 端口下拉选择框（COM1, COM2, COM15等）
  - 波特率下拉选择框（9600, 115200, 2000000等）
  - 连接/断开按钮
  
- 接收配置区
  - 保存日志复选框
  - HEX显示复选框
  - 过滤器复选框

- 发送配置区
  - HEX发送复选框
  - 发送"\r\n"复选框

**中间接收显示区：**
- 大型文本显示区域，显示串口接收的实时数据
- 支持自动滚动
- 支持数据复制和保存
- 显示时间戳
- 支持清空缓存

**右侧功能面板：**
- 上半部分：过滤日志区域
  - 显示经过关键字过滤的日志内容
  - 支持关键字搜索输入框
  - 实时过滤显示
  
- 下半部分：发送区域
  - 命令输入框
  - 发送按钮
  - 预设命令按钮列表（如图中的dbg reboot, dbg led on等）
  - 自动发送复选框

#### 2.2 界面功能特性
- **响应式设计**：支持窗口大小调整
- **主题支持**：深色主题（如截图所示）
- **状态指示**：连接状态、数据收发指示灯
- **快捷键支持**：常用操作快捷键
- **配置保存**：记住用户配置（端口、波特率等）

### 3. MCP服务接口

#### 3.1 工具接口 (Tools)

**Tool 1: 查询串口日志**
- **接口名称**: `query_serial_logs`
- **功能描述**: 从串口接收缓存中查找包含指定关键字的日志行
- **参数**:
  - `keyword` (string, required): 搜索关键字
  - `max_lines` (int, optional): 最大返回行数，默认50
  - `time_range` (string, optional): 时间范围筛选（如"last_5min"）
  - `case_sensitive` (bool, optional): 是否区分大小写，默认false
- **返回**: 匹配的日志行列表，包含时间戳和内容

**Tool 2: 发送串口命令**
- **接口名称**: `send_serial_command`
- **功能描述**: 通过串口发送命令到设备
- **参数**:
  - `command` (string, required): 要发送的命令
  - `encoding` (string, optional): 编码格式，默认"utf-8"
  - `add_newline` (bool, optional): 是否添加换行符，默认true
  - `wait_response` (bool, optional): 是否等待响应，默认false
  - `timeout` (float, optional): 等待响应超时时间（秒），默认3.0
- **返回**: 发送状态和响应内容（如果等待响应）

**Tool 3: 串口状态查询**
- **接口名称**: `get_serial_status`
- **功能描述**: 获取当前串口连接状态和配置信息
- **参数**: 无
- **返回**: 串口状态、配置参数、接收缓存统计等

**Tool 4: 串口配置管理**
- **接口名称**: `configure_serial`
- **功能描述**: 配置或重新连接串口
- **参数**:
  - `port` (string, optional): 串口名称
  - `baudrate` (int, optional): 波特率
  - `timeout` (float, optional): 超时时间
  - `reconnect` (bool, optional): 是否重新连接
- **返回**: 配置结果和新的连接状态

**Tool 5: 预设命令管理**
- **接口名称**: `manage_preset_commands`
- **功能描述**: 管理预设命令列表
- **参数**:
  - `action` (string, required): 操作类型（list/add/remove/execute）
  - `command` (string, optional): 命令内容
  - `name` (string, optional): 命令名称
- **返回**: 操作结果和当前预设命令列表

#### 3.2 资源接口 (Resources)

**Resource 1: 实时日志流**
- **资源名称**: `serial://logs/stream`
- **功能描述**: 提供实时串口数据流
- **内容类型**: text/plain
- **更新频率**: 实时

**Resource 2: 历史日志**
- **资源名称**: `serial://logs/history`
- **功能描述**: 提供历史日志数据
- **内容类型**: application/json
- **查询参数**: 支持时间范围、关键字过滤

**Resource 3: 预设命令列表**
- **资源名称**: `serial://commands/presets`
- **功能描述**: 提供预设命令配置
- **内容类型**: application/json

### 4. 技术实现要求

#### 4.1 技术约束
- **GUI框架**: 必须使用PyQt6实现图形用户界面
- **界面风格**: 采用现代化深色主题，参考提供的界面截图设计
- **跨平台**: 支持Windows、Linux、macOS平台
- **Python版本**: 要求Python 3.8+（PyQt6兼容性要求）

#### 4.2 核心依赖
- `mcp` - MCP协议实现
- `pyserial` - 串口通信
- `asyncio` - 异步处理
- `threading` - 多线程管理
- `PyQt6` - GUI界面（指定技术栈）
- `logging` - 日志记录

#### 4.3 架构设计
- **分层架构**：
  - GUI层：用户界面交互
  - Service层：业务逻辑处理
  - MCP层：协议接口实现
  - Hardware层：串口硬件接口

- **数据流**：
  - 串口数据 → 数据处理 → 界面显示 + MCP接口
  - GUI操作 → 业务逻辑 → 串口发送
  - MCP请求 → 业务逻辑 → 数据查询/命令执行

#### 4.4 数据存储
- 内存循环缓冲区存储接收数据
- 可配置缓存大小限制
- 支持数据持久化（可选）
- 预设命令配置文件存储

#### 4.5 错误处理
- 串口连接异常处理
- 数据解析错误处理
- MCP协议错误处理
- GUI异常处理
- 友好的错误信息返回

### 5. 使用场景

#### 5.1 开发者直接调试
- 通过GUI界面直接与设备交互
- 实时查看串口数据
- 快速发送调试命令
- 保存和分析日志数据

#### 5.2 LLM辅助开发
- 在VSCode/Cursor中通过LLM查询设备日志
- 通过LLM发送调试命令
- 实时监控设备状态
- 智能故障诊断

#### 5.3 自动化测试
- LLM驱动的设备功能测试
- 日志分析和问题诊断
- 批量命令执行
- 测试结果记录和分析

### 6. 配置和部署

#### 6.1 配置文件
- `config.json`: 主配置文件
  - 默认串口参数
  - GUI主题设置
  - MCP服务配置
  - 日志配置

- `presets.json`: 预设命令配置
  - 命令名称和内容
  - 分组管理
  - 快捷键绑定

#### 6.2 启动模式
- **GUI模式**: 启动带界面的完整应用
- **MCP模式**: 仅启动MCP服务（无界面）
- **混合模式**: 同时提供GUI和MCP服务（默认）

## 开发优先级

### 第一阶段（核心功能）
1. 串口基础通信功能
2. 基本GUI界面
3. 核心MCP接口

### 第二阶段（完善功能）
1. 高级过滤和搜索
2. 预设命令管理
3. 配置文件支持

### 第三阶段（优化提升）
1. 性能优化
2. 错误处理完善
3. 文档和测试

---

**项目目标**：创建一个功能完整、界面友好、协议标准的串口调试和MCP服务工具，既满足开发者直接使用需求，又能很好地与LLM集成。 